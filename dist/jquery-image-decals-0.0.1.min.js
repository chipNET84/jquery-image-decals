jQuery.fn.imageDecals=function(a){"use strict";var b={tools:[]},c=jQuery.extend({},b,a),d=0,e=function(){return d+=1,"image-composer-uid-"+d},f=function(a,b){var c=this,d=function(){},e={scaleDecalDimension:!1,domain:{width:100,height:100},decals:[],data:[],events:{onDecalClicked:d}};this.img=new g(a),this.cfg=jQuery.extend({},e,b),this.scale={width:1,height:1},this.img.dimension(function(){c.init()}),this.events=this.cfg.events,this.$target=a};f.prototype={toJSON:function(){var a=this.decalHolder.toObject();return JSON.stringify(a)},init:function(){var a,b=this,c=jQuery('<div class="image-composer-decals"></div>'),d=jQuery('<div class="image-composer-palette"></div>');this.scale.width=this.img.width/this.cfg.domain.width,this.scale.height=this.img.height/this.cfg.domain.height,this.renderer=new k(this.$target,this.img),this.renderer.$target.parent().find(".image-composer-canvas").append(c),this.decalHolder=new h(c,{scaleDecalDimension:this.cfg.scaleDecalDimension,dimension:{width:this.img.width,height:this.img.height},scale:this.scale,items:[]}),this.decalHolder.$target.on("decal-item-clicked",function(a,c){b.events.onDecalClicked.call(a.target,a,c.decal)}),this.renderer.$target.parent().append(d),this.decalPalette=new j(d,this.cfg.decals),this.decalPalette.$target.on("decal-palette-item-clicked",function(a,c){b.decalHolder.addDecal(new i(b.cfg.decals[c.decal.key]))}),this.cfg.data.forEach(function(c){a=jQuery.extend(!0,{},b.cfg.decals[c.key]),a.width=c.width,a.height=c.height,a.left=c.left,a.top=c.top,b.decalHolder.addDecal(new i(a),!0)}),this.decalHolder.render(),this.decalPalette.render()}};var g=function(a){var b,c,d,e=a[0];if(b="IMAGE"===e.tagName||"IMG"===e.tagName,c=a.css("background-image").length>0,!b&&!c)throw"jquery-image-composer requires an image or element with background image to work";d=b?e.getAttribute("src"):a.css("background-image"),this.width=a.width(),this.height=a.height(),this.src=d,this.img=void 0};g.prototype.dimension=function(a){var b,c=this,d=function(){c.width=this.width,c.height=this.height,"[object Function]"===Object.prototype.toString.call(a)&&a({x:this.width,y:this.height})};b=new Image,b.onload=d,b.src=this.src,this.img=b};var h=function(a,b){var c,d=this;for(this.scale=b.scale,this.items=b.items,this.scaleDecalDimension=b.scaleDecalDimension,this.itemsMap={},c=0;c<this.items.length;c+=1)this.itemsMap[this.items[c].uid]=this.items[c];this.cfg=b,this.$target=a,this.$target.css("width",b.dimension.width+"px"),this.$target.css("height",b.dimension.height+"px"),this.$target.on("click","span",function(a){if(a.target&&a.target.getAttribute("data-uid")){var b=a.target.getAttribute("data-uid"),c=d.itemsMap.hasOwnProperty(b)?d.itemsMap[b]:void 0;d.$target.find(".image-composer-decal-selected").removeClass("image-composer-decal-selected"),$(a.target).addClass("image-composer-decal-selected"),d.$target.trigger("decal-item-clicked",{decal:c})}})};h.prototype={render:function(){var a,b=document.createDocumentFragment(),c=this;this.items.forEach(function(d){a=c._createElement(d),b.appendChild(a)}),this.$target.append(b),this._applyDraggable()},_applyDraggable:function(){var a=this;this.$target.find(".draggable").draggable({containment:"parent",stop:function(b,c){var d=b.target.getAttribute("data-uid");a.itemsMap[d].left=c.position.left,a.itemsMap[d].top=c.position.top,a.items.every(function(a){var b=!1;return a.uid===d&&(a.left=c.position.left,a.top=c.position.top,b=!0),!b})}})},_createElement:function(a){var b=document.createElement("span"),c=Math.floor;return b.className=a.key+" draggable",b.title=a.title,b.setAttribute("data-uid",a.uid),b.style.backgroundImage="url("+a.src+")",this.scaleDecalDimension?(b.style.width=c(this.scale.width*a.width)+"px",b.style.height=c(this.scale.height*a.height)+"px"):(b.style.width=a.width+"px",b.style.height=a.height+"px"),b.style.left=c(this.scale.width*a.left)+"px",b.style.top=c(this.scale.height*a.top)+"px",b},renderOne:function(a){var b,c;a="[object Number]"===Object.prototype.toString.call(a)?a:-1,-1!==a&&(b=this.items[a],c=this._createElement(b),this.$target.append(c),this._applyDraggable())},addDecal:function(a,b){this.items.push(a),this.itemsMap[a.uid]=a,b||this.renderOne(this.items.length-1)},removeDecal:function(a){var b=-1,c=!1;this.items.every(function(d,e){return d.uid===a.uid&&(b=e,c=!0),!c}),-1!==b&&c&&(delete this.itemsMap[a.uid],this.items.splice(b,1),this.$target.find("[data-uid="+a.uid+"]").remove())}};var i=function(a){this.key=a.key,this.src=a.src,this.width=a.width||-1,this.height=a.height||-1,this.left=a.left,this.top=a.top,this.title=a.title||"",this.uid=e()};h.prototype.toObject=function(){var a,b,c=[];return this.items.forEach(function(d){b=jQuery("[data-uid="+d.uid+"]"),a={key:d.key,width:d.width,height:d.height,left:d.left,top:d.top},c.push(a)}),c};var j=function(a,b){var c,d=this;this.items=[],this.itemsMap=b;for(c in this.itemsMap)this.itemsMap.hasOwnProperty(c)&&this.items.push(new i(this.itemsMap[c]));this.$target=a,this.$target.on("click",".decal-palette-item",function(a){if(a.target&&a.target.getAttribute("data-key")){var b=a.target.getAttribute("data-key"),c=d.itemsMap.hasOwnProperty(b)?d.itemsMap[b]:void 0;d.$target.trigger("decal-palette-item-clicked",{decal:c})}})};j.prototype={render:function(){var a,b,c,d=document.createDocumentFragment();for(a=0;a<this.items.length;a+=1)c=this.items[a],b=document.createElement("div"),b.className="decal-palette-item",b.setAttribute("data-key",c.key),b.style.backgroundImage="url("+c.src+")",b.style.width=c.width+"px",b.style.height=c.height+"px",d.appendChild(b);this.$target.append(d)}};var k=function(a,b){if(!b instanceof g)throw"need Img instance to render";a.wrap('<div class="image-composer-wrap"></div>'),this.$target=a,this.compImg=b,this.place()};return k.prototype.place=function(){this.$target.hide();var a=document.createElement("div");a.className="image-composer-canvas",a.appendChild(this.compImg.img),this.$target.after(a)},this.each(function(){var a=jQuery(this),b=new f(a,c);a.data("imageDecals",b)}),this};